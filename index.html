<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸŽ® Panel Admin</title>

<!-- ðŸ”¥ Firebase v9 COMPAT (UNO SOLO) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  background:#06010d;
  font-family:Arial,Helvetica,sans-serif;
  color:#fff;
}
h2{margin:0 0 12px;color:#c58bff}

.container{
  display:flex;
  gap:20px;
  padding:20px;
  max-width:1100px;
  margin:auto;
}
.card{
  flex:1;
  background:#0c0718;
  border-radius:22px;
  padding:20px;
  box-shadow:0 0 40px #7f4cff;
}
input,select,textarea{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:none;
  background:#120c22;
  color:#fff;
  margin-top:8px;
}
textarea{min-height:120px}
button{
  margin-top:12px;
  padding:12px;
  width:100%;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg,#8a5cff,#c58bff);
  font-weight:bold;
}
.user{
  background:#120c22;
  padding:12px;
  border-radius:14px;
  margin-top:10px;
}
.actions{display:flex;gap:6px;margin-top:6px}
.actions input{flex:1;text-align:center}
.plus{background:#00ffcc;color:#000}
.minus{background:#ff5b5b;color:#fff}
.msg{margin-top:8px;text-align:center}
.ok{color:#5bff9a}
.error{color:#ff5b5b}
.hidden{display:none}
</style>
</head>

<body>

<div class="container">

<!-- ðŸ’° SALDOS -->
<div class="card">
  <h2>ðŸ’° SALDOS</h2>
  <input id="buscar" placeholder="Buscar correo o ID" oninput="buscarUsuario()">
  <div id="estado">Cargando usuarios...</div>
  <div id="lista"></div>
</div>

<!-- ðŸ”‘ KEYS -->
<div class="card">
  <h2>ðŸ”‘ KEYS</h2>

  <label>Producto</label>
  <select id="producto">
    <option>Cargando...</option>
  </select>

  <label>Keys (1 por lÃ­nea)</label>
  <textarea id="keys"></textarea>

  <button onclick="guardarKeys()">AGREGAR KEYS</button>
  <div id="msg" class="msg"></div>
</div>

</div>

<script>
/* ðŸ”¥ FIREBASE CONFIG (EL TUYO, SIN TOCAR) */
const firebaseConfig = {
  apiKey: "AIzaSyAKrBTAkJGhB9s3E3MExqzj8mtXgKYsWRc",
  authDomain: "davidstore-51f7f.firebaseapp.com",
  projectId: "davidstore-51f7f"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ================= SALDOS ================= */
const lista = document.getElementById("lista");
const estado = document.getElementById("estado");

db.collection("login").onSnapshot(snap=>{
  lista.innerHTML="";
  estado.textContent = "Usuarios: " + snap.size;

  snap.forEach(d=>{
    const u=d.data();
    lista.innerHTML+=`
      <div class="user">
        ðŸ“§ <b>${u.email}</b><br>
        ðŸ’° Saldo: <b>${u.saldo ?? 0}</b><br>
        <small>${d.id}</small>
        <div class="actions">
          <input type="number" id="m_${d.id}" placeholder="Monto">
          <button class="plus" onclick="cambiarSaldo('${d.id}',1)">+</button>
          <button class="minus" onclick="cambiarSaldo('${d.id}',-1)">-</button>
        </div>
      </div>
    `;
  });
});

function buscarUsuario(){
  const t=buscar.value.toLowerCase();
  document.querySelectorAll(".user").forEach(u=>{
    u.style.display = u.innerText.toLowerCase().includes(t) ? "block":"none";
  });
}

function cambiarSaldo(id,signo){
  const m = Number(document.getElementById("m_"+id).value);
  if(!m||m<=0) return;
  db.collection("login").doc(id).update({
    saldo: firebase.firestore.FieldValue.increment(m*signo)
  });
}

/* ================= KEYS ================= */
const sel=document.getElementById("producto");

db.collection("claves").get().then(snap=>{
  sel.innerHTML="<option value=''>Selecciona producto</option>";
  if(snap.empty){
    sel.innerHTML+="<option disabled>No hay productos</option>";
  }
  snap.forEach(d=>{
    const o=document.createElement("option");
    o.value=d.id;
    o.textContent=d.id;
    sel.appendChild(o);
  });
});

function guardarKeys(){
  const prod=sel.value;
  const texto=keys.value.trim();
  const msg=document.getElementById("msg");

  if(!prod){msg.textContent="Selecciona producto";msg.className="msg error";return;}
  if(!texto){msg.textContent="Pega las keys";msg.className="msg error";return;}

  const arr=texto.split("\n").map(x=>x.trim()).filter(x=>x);

  db.collection("claves").doc(prod).update({
    lista: firebase.firestore.FieldValue.arrayUnion(...arr)
  }).then(()=>{
    msg.textContent="Keys agregadas";
    msg.className="msg ok";
    keys.value="";
  }).catch(()=>{
    msg.textContent="Error al guardar";
    msg.className="msg error";
  });
}
</script>

</body>
</html>