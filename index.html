<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Key Generator Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
body{
  background:radial-gradient(circle at top,#1a1033,#05010a);
  font-family:Arial;
  color:#fff;
}
.panel{
  max-width:420px;
  margin:40px auto;
  background:#070b18;
  padding:26px;
  border-radius:26px;
  box-shadow:0 0 40px #a855f7;
}
h2{text-align:center;color:#c084fc}
label{display:block;margin-top:16px;opacity:.85}
select,textarea{
  width:100%;
  margin-top:8px;
  padding:14px;
  border-radius:16px;
  border:none;
  background:#0f172a;
  color:#fff;
}
textarea{min-height:140px;resize:none}
button{
  width:100%;
  margin-top:22px;
  padding:18px;
  border:none;
  border-radius:20px;
  font-size:18px;
  font-weight:900;
  background:linear-gradient(135deg,#c084fc,#7c3aed);
  color:#000;
}
#msg{text-align:center;margin-top:12px;font-weight:700}
.hidden{display:none}
</style>
</head>

<body>

<div class="panel">
  <h2>üîë Key Generator</h2>

  <label>Producto</label>
  <select id="producto"></select>

  <label>Duraci√≥n</label>
  <select id="duracion"></select>

  <label>Agregar Keys (1 por l√≠nea)</label>
  <textarea id="keys"></textarea>

  <button onclick="guardarKeys()">‚ö° AGREGAR KEYS</button>
  <div id="msg" class="hidden"></div>
</div>

<script>
// üî• TU FIREBASE REAL
firebase.initializeApp({
  apiKey: "TU_API_KEY",
  authDomain: "TU_AUTH_DOMAIN",
  projectId: "TU_PROJECT_ID"
});
const db = firebase.firestore();

// üîÑ CARGAR PRODUCTOS
let productosCache = {};

db.collection("productos").onSnapshot(snap=>{
  const selProducto = document.getElementById("producto");
  selProducto.innerHTML = "";
  productosCache = {};

  snap.forEach(doc=>{
    productosCache[doc.id] = doc.data();
    const opt = document.createElement("option");
    opt.value = doc.id;
    opt.textContent = doc.data().nombre;
    selProducto.appendChild(opt);
  });

  cargarDuraciones();
});

// üîÑ CARGAR DURACIONES SEG√öN PRODUCTO
function cargarDuraciones(){
  const id = document.getElementById("producto").value;
  const selDur = document.getElementById("duracion");
  selDur.innerHTML = "";

  Object.entries(productosCache).forEach(([docId,data])=>{
    if(data.nombre === productosCache[id].nombre){
      const opt = document.createElement("option");
      opt.value = docId;
      opt.textContent = data.dias + " d√≠as";
      selDur.appendChild(opt);
    }
  });
}

document.getElementById("producto")
  .addEventListener("change", cargarDuraciones);

// üíæ GUARDAR KEYS
async function guardarKeys(){
  const msg = document.getElementById("msg");
  msg.classList.add("hidden");

  const idProducto = document.getElementById("duracion").value;
  const texto = document.getElementById("keys").value.trim();

  if(!texto){
    msg.textContent = "‚ùå No hay keys";
    msg.style.color="red";
    msg.classList.remove("hidden");
    return;
  }

  const nuevas = texto.split("\n").map(k=>k.trim()).filter(Boolean);
  const ref = db.collection("claves").doc(idProducto);

  try{
    await db.runTransaction(async tx=>{
      const snap = await tx.get(ref);
      if(!snap.exists){
        tx.set(ref,{lista:nuevas});
      }else{
        tx.update(ref,{lista:snap.data().lista.concat(nuevas)});
      }
    });

    msg.textContent = "‚úÖ Keys guardadas: "+nuevas.length;
    msg.style.color="#22c55e";
    msg.classList.remove("hidden");
    document.getElementById("keys").value="";

  }catch(e){
    msg.textContent = "‚ùå Error Firestore Rules";
    msg.style.color="red";
    msg.classList.remove("hidden");
    console.error(e);
  }
}
</script>

</body>
</html>