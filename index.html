<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>üéÆ Panel Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- üî• FIREBASE COMPAT (OBLIGATORIO) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:#05020b;
  color:#fff;
}
.hidden{display:none}

.container{
  max-width:520px;
  margin:auto;
  padding:20px;
}

/* LOGIN */
.login{
  margin-top:80px;
  background:#0d0820;
  padding:24px;
  border-radius:20px;
  box-shadow:0 0 40px #7f4cff;
}
.login h2{text-align:center;color:#b57cff}
.login input{
  width:100%;
  margin-top:12px;
  padding:14px;
  border:none;
  border-radius:14px;
  background:#160f30;
  color:#fff;
}
.login button{
  width:100%;
  margin-top:16px;
  padding:14px;
  border:none;
  border-radius:16px;
  background:linear-gradient(135deg,#8a5cff,#c58bff);
  font-weight:bold;
}

/* TOP MENU */
.menu{
  display:flex;
  gap:12px;
  margin-bottom:16px;
}
.menu button{
  flex:1;
  padding:14px;
  border:none;
  border-radius:16px;
  background:#1a103a;
  color:#b57cff;
  font-weight:bold;
}
.menu button.active{
  background:linear-gradient(135deg,#8a5cff,#c58bff);
  color:#000;
}

/* CARDS */
.card{
  background:#0d0820;
  border-radius:22px;
  padding:20px;
  box-shadow:0 0 40px #7f4cff;
}
h3{text-align:center;color:#b57cff}

/* SALDOS */
.user{
  background:#140d30;
  border-radius:14px;
  padding:14px;
  margin-top:12px;
}
.user small{color:#aaa}
.actions{
  display:flex;
  gap:8px;
  margin-top:8px;
}
.actions input{
  flex:1;
  padding:10px;
  border:none;
  border-radius:10px;
  background:#1f1450;
  color:#fff;
  text-align:center;
}
.plus{background:#5bff9a;border:none;border-radius:10px}
.minus{background:#ff5b5b;border:none;border-radius:10px;color:#fff}

/* KEYS */
select,textarea{
  width:100%;
  margin-top:10px;
  padding:14px;
  border:none;
  border-radius:14px;
  background:#160f30;
  color:#fff;
}
textarea{min-height:120px}
.save{
  width:100%;
  margin-top:14px;
  padding:14px;
  border:none;
  border-radius:16px;
  background:linear-gradient(135deg,#8a5cff,#c58bff);
  font-weight:bold;
}
.msg{text-align:center;margin-top:10px}
.ok{color:#5bff9a}
.err{color:#ff5b5b}

.logout{
  margin-top:20px;
  width:100%;
  padding:14px;
  border:none;
  border-radius:16px;
  background:#ff5b5b;
  color:#fff;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="container">

<!-- üîê LOGIN -->
<div id="loginBox" class="login">
  <h2>üîê LOGIN ADMIN</h2>
  <input id="email" placeholder="Correo">
  <input id="pass" type="password" placeholder="Contrase√±a">
  <button onclick="login()">ENTRAR</button>
</div>

<!-- üéÆ PANEL -->
<div id="panelBox" class="hidden">

  <div class="menu">
    <button id="btnSaldo" class="active" onclick="verSaldo()">üí∞ SALDOS</button>
    <button id="btnKeys" onclick="verKeys()">üîë KEYS</button>
  </div>

  <!-- üí∞ SALDOS -->
  <div id="saldoBox" class="card">
    <h3>üí∞ SALDOS</h3>
    <input id="buscar" placeholder="Buscar correo o ID" oninput="buscarUsuario()">
    <div id="estado">Cargando usuarios...</div>
    <div id="lista"></div>
  </div>

  <!-- üîë KEYS -->
  <div id="keysBox" class="card hidden">
    <h3>üîë KEYS</h3>
    <label>Producto</label>
    <select id="producto"><option>Cargando...</option></select>

    <label>Keys (1 por l√≠nea)</label>
    <textarea id="keys"></textarea>

    <button class="save" onclick="guardarKeys()">AGREGAR KEYS</button>
    <div id="msg" class="msg"></div>
  </div>

  <button class="logout" onclick="logout()">CERRAR SESI√ìN</button>

</div>
</div>

<script>
/* üî• FIREBASE CONFIG (CORRECTO) */
firebase.initializeApp({
  apiKey: "AIzaSyAKrBTAkJGhB9s3E3MExqzj8mtXgKYsWRc",
  authDomain: "davidstore-51f7f.firebaseapp.com",
  projectId: "davidstore-51f7f",
  storageBucket: "davidstore-51f7f.appspot.com",
  messagingSenderId: "363278778609",
  appId: "1:363278778609:web:0714ebb6903b931a616950"
});

const auth = firebase.auth();
const db   = firebase.firestore();

/* AUTH */
auth.onAuthStateChanged(u=>{
  loginBox.classList.toggle("hidden",!!u);
  panelBox.classList.toggle("hidden",!u);
  if(u){cargarUsuarios();cargarProductos();}
});

function login(){
  auth.signInWithEmailAndPassword(email.value,pass.value)
  .catch(e=>alert(e.message));
}
function logout(){auth.signOut();}

/* VISTAS */
function verSaldo(){
  saldoBox.classList.remove("hidden");
  keysBox.classList.add("hidden");
  btnSaldo.classList.add("active");
  btnKeys.classList.remove("active");
}
function verKeys(){
  saldoBox.classList.add("hidden");
  keysBox.classList.remove("hidden");
  btnKeys.classList.add("active");
  btnSaldo.classList.remove("active");
}

/* SALDOS */
async function cargarUsuarios(){
  lista.innerHTML="";
  const snap=await db.collection("login").get();
  estado.textContent=`Usuarios: ${snap.size}`;
  snap.forEach(d=>{
    const u=d.data();
    lista.innerHTML+=`
    <div class="user">
      üìß <b>${u.email}</b><br>
      üí∞ Saldo: <b>${u.saldo||0}</b><br>
      <small>${d.id}</small>
      <div class="actions">
        <input id="m_${d.id}" type="number" placeholder="Monto">
        <button class="plus" onclick="saldo('${d.id}',1)">+</button>
        <button class="minus" onclick="saldo('${d.id}',-1)">-</button>
      </div>
    </div>`;
  });
}
function buscarUsuario(){
  const t=buscar.value.toLowerCase();
  document.querySelectorAll(".user").forEach(u=>{
    u.style.display=u.innerText.toLowerCase().includes(t)?"block":"none";
  });
}
function saldo(id,s){
  const m=Number(document.getElementById("m_"+id).value);
  if(!m)return;
  db.collection("login").doc(id).update({
    saldo:firebase.firestore.FieldValue.increment(m*s)
  }).then(cargarUsuarios);
}

/* KEYS */
function cargarProductos(){
  const sel=producto;
  sel.innerHTML="<option>Cargando...</option>";
  db.collection("claves").get().then(s=>{
    sel.innerHTML="<option value=''>Selecciona producto</option>";
    s.forEach(d=>{
      const o=document.createElement("option");
      o.value=d.id;o.textContent=d.id;
      sel.appendChild(o);
    });
  });
}
function guardarKeys(){
  const prod=producto.value;
  const text=keys.value.trim();
  if(!prod||!text)return msgError("Datos incompletos");
  const arr=text.split("\n").map(x=>x.trim()).filter(x=>x);
  db.collection("claves").doc(prod).update({
    lista:firebase.firestore.FieldValue.arrayUnion(...arr)
  }).then(()=>{
    msgOk("Keys agregadas");
    keys.value="";
  }).catch(()=>msgError("Error Firebase"));
}
function msgOk(t){msg.textContent=t;msg.className="msg ok"}
function msgError(t){msg.textContent=t;msg.className="msg err"}
</script>

</body>
</html>