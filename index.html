<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ğŸ® Panel Admin Total</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ğŸ”¥ Firebase v9 COMPAT -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  background:#05010a;
  font-family:Arial,Helvetica,sans-serif;
  color:#fff;
}
h2{color:#b57cff;text-align:center}
.container{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
  padding:20px;
}
.card{
  background:#0c0718;
  border-radius:20px;
  padding:20px;
  box-shadow:0 0 35px #7f4cff;
}
input,select,textarea{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:12px;
  border:none;
  background:#140c28;
  color:#fff;
}
textarea{min-height:120px}
button{
  width:100%;
  margin-top:14px;
  padding:12px;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg,#8a5cff,#c58bff);
  font-weight:bold;
  cursor:pointer;
}
.user{
  background:#140c28;
  padding:12px;
  border-radius:14px;
  margin-top:10px;
}
.actions{
  display:flex;
  gap:8px;
  margin-top:8px;
}
.msg{text-align:center;margin-top:10px}
.ok{color:#5bff9a}
.error{color:#ff5b5b}
.login{
  max-width:360px;
  margin:80px auto;
}
.hidden{display:none}
</style>
</head>

<body>

<!-- ğŸ” LOGIN -->
<div id="loginBox" class="login">
  <h2>ğŸ” LOGIN ADMIN</h2>
  <input id="email" placeholder="Correo">
  <input id="pass" type="password" placeholder="ContraseÃ±a">
  <button onclick="login()">ENTRAR</button>
</div>

<!-- ğŸ® PANEL -->
<div id="panelBox" class="hidden">
  <div class="container">

    <!-- ğŸ’° SALDOS -->
    <div class="card">
      <h2>ğŸ’° SALDOS</h2>
      <div id="estado">Cargando usuarios...</div>
      <div id="usuarios"></div>
    </div>

    <!-- ğŸ”‘ KEYS -->
    <div class="card">
      <h2>ğŸ”‘ KEYS</h2>

      <label>Producto</label>
      <select id="producto"><option>Cargando...</option></select>

      <label>Keys (1 por lÃ­nea)</label>
      <textarea id="keys"></textarea>

      <button onclick="guardarKeys()">AGREGAR KEYS</button>
      <div id="msg" class="msg"></div>
    </div>

  </div>
</div>

<script>
/* ğŸ”¥ FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyAKrBTAkJGhB9s3E3MExqzj8mtXgKYsWRc",
  authDomain: "davidstore-51f7f.firebaseapp.com",
  projectId: "davidstore-51f7f"
});

const auth = firebase.auth();
const db   = firebase.firestore();

/* ğŸ” AUTH */
auth.onAuthStateChanged(u=>{
  if(u){
    loginBox.classList.add("hidden");
    panelBox.classList.remove("hidden");
    cargarUsuarios();
    cargarProductos();
  }else{
    loginBox.classList.remove("hidden");
    panelBox.classList.add("hidden");
  }
});

function login(){
  auth.signInWithEmailAndPassword(email.value,pass.value)
    .catch(e=>alert(e.message));
}

/* ğŸ’° SALDOS */
function cargarUsuarios(){
  usuarios.innerHTML="";
  db.collection("login").get().then(snap=>{
    estado.textContent="ğŸ‘¥ Usuarios: "+snap.size;
    snap.forEach(d=>{
      const u=d.data();
      usuarios.innerHTML+=`
        <div class="user">
          ğŸ“§ ${u.email}<br>
          ğŸ’° Saldo: <b>${u.saldo||0}</b>
          <div class="actions">
            <input id="m_${d.id}" type="number" placeholder="Monto">
            <button onclick="cambiarSaldo('${d.id}',1)">â•</button>
            <button onclick="cambiarSaldo('${d.id}',-1)">â–</button>
          </div>
        </div>
      `;
    });
  });
}

function cambiarSaldo(id,s){
  const v=Number(document.getElementById("m_"+id).value);
  if(!v) return;
  db.collection("login").doc(id).update({
    saldo: firebase.firestore.FieldValue.increment(v*s)
  }).then(cargarUsuarios);
}

/* ğŸ”‘ KEYS */
function cargarProductos(){
  producto.innerHTML="<option>Cargando...</option>";
  db.collection("claves").get().then(snap=>{
    producto.innerHTML="<option value=''>Selecciona</option>";
    snap.forEach(d=>{
      producto.innerHTML+=`<option value="${d.id}">${d.id}</option>`;
    });
  });
}

function guardarKeys(){
  const p=producto.value;
  const t=keys.value.trim();
  if(!p||!t) return;
  const arr=t.split("\n").map(x=>x.trim()).filter(x=>x);
  db.collection("claves").doc(p).update({
    lista: firebase.firestore.FieldValue.arrayUnion(...arr)
  }).then(()=>{
    msg.textContent="âœ… Keys agregadas";
    msg.className="msg ok";
    keys.value="";
  }).catch(()=>{
    msg.textContent="âŒ Error";
    msg.className="msg error";
  });
}
</script>

</body>
</html>